[{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com Selenium + 鉅亨網 + MonogoDB 參考資料\r\r高级爬虫: 让 Selenium 控制你的浏览器帮你爬 在Windows上安裝Python \u0026 Selenium + 簡易教學 \r\r Selenium Record and Playback tool\r\rSelenium IDE Selenium Record and Playback tool for ease of getting acquainted with Selenium WebDriver.\r\r ","date":"2021-02-01","objectID":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/:0:0","tags":["Selenium","bs4","urllib","MongoDB"],"title":"TWSE [13] Selenium + 鉅亨網","uri":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"ChromeDriver - WebDriver for Chrome import selenium selenium.__version__ ","date":"2021-02-01","objectID":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:0","tags":["Selenium","bs4","urllib","MongoDB"],"title":"TWSE [13] Selenium + 鉅亨網","uri":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"開啟Google首頁 from selenium import webdriver browser = webdriver.Chrome() browser.get('http://google.com/') ","date":"2021-02-01","objectID":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:1","tags":["Selenium","bs4","urllib","MongoDB"],"title":"TWSE [13] Selenium + 鉅亨網","uri":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"開啟鉅亨網台股新聞 browser = webdriver.Chrome() driver.get(\"https://news.cnyes.com/news/cat/tw_stock_news?exp=a\") document.body.scrollHeight 參考資料\r\rHow can I scroll a web page using selenium webdriver in python? [爬蟲實戰] 如何透過Selenium 自動將頁面捲動至最下方抓取資料? 用python實現selenium 自動化測試 \r\r driver.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\") print(driver.execute_script(\"return document.body.scrollHeight\")) pause_time = 10 for i in range(10): driver.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\") time.sleep(pause_time) ChromeOptions() 參考資料\r\rPython selenium.webdriver.ChromeOptions() Examples Python selenium.webdriver 模块，ChromeOptions() 实例源码 Python webdriver.ChromeOptions方法代碼示例 \r\r start = time.time() driver = webdriver.Chrome() driver.get(\"https://news.cnyes.com/news/cat/tw_stock_news?exp=a\") for i in range(2): driver.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\") time.sleep(pause_time) driver.close() end = time.time() print(end - start) start = time.time() options = webdriver.ChromeOptions() options.add_experimental_option(\"prefs\", {'ignore_image': 2}) options.add_argument('--headless') options.add_argument('--disable-gpu') driver = webdriver.Chrome(chrome_options=options) driver.get(\"https://news.cnyes.com/news/cat/tw_stock_news?exp=a\") for i in range(2): driver.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\") time.sleep(pause_time) driver.close() end = time.time() print(end - start) 執行時間比較\r\r\r\r ","date":"2021-02-01","objectID":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:2","tags":["Selenium","bs4","urllib","MongoDB"],"title":"TWSE [13] Selenium + 鉅亨網","uri":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"Bs4 options = webdriver.ChromeOptions() options.add_experimental_option(\"prefs\", {'ignore_image': 2}) options.add_argument('--headless') options.add_argument('--disable-gpu') driver = webdriver.Chrome(chrome_options=options) driver.get(\"https://news.cnyes.com/news/cat/tw_stock_news?exp=a\") for i in range(2): driver.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\") time.sleep(pause_time) soup = BeautifulSoup(driver.page_source, 'html.parser') driver.close() MongoDB 抓出已存檔的past_post_ids myclient = pymongo.MongoClient(\"mongodb://localhost:27017/\") mydb = myclient[\"article\"] mycol = mydb[\"2021_鉅亨網\"] past_post_ids = [] end = datetime.datetime.now() start = end - datetime.timedelta(days = 3) for x in mycol.find({'Date': {\"$gte\": start,\"$lte\": end}}): past_post_ids.append(x[\"post_id\"]) 從網站上抓下來的post_ids hrefs = soup.find_all('a') post_ids = [] import regex as re for href in hrefs: if re.match('/news/id/', str(href.get('href'))): post_id = str(href.get('href')).split('/')[-1].split('?')[0] post_ids.append(post_id) past_post_ids\u0026post_ids差集 A = ['A','B','C','D'] B = ['B','F'] C = [] for x in B: if x in A: None else: C.append(x) C new_post_ids = [] for _id in post_ids: if _id in past_post_ids: None else: new_post_ids.append(_id) print(len(past_post_ids)) print(len(post_ids)) print(len(new_post_ids)) 圖片解說\r\rSet (mathematics)\r\r 存成urls urls = ['https://news.cnyes.com/news/id/{}?exp=a'.format(e) for e in new_post_ids] def get_text(i): post_id = urls[i].split('/')[5].split('?')[0] data = urllib.request.urlopen(urls[i]) soup = BeautifulSoup(data, 'html.parser') P = soup.find_all('p') text = '' for i,p in zip(range(0,len(P)),P): if i \u003e=4: text = text + p.getText() i += 1 tags = soup.find_all('a') n_tags = [] for tag in tags: if re.match('/tag/', str(tag.get('href'))): n_tags.append(str(tag.get('href'))[5:len(str(tag.get('href')))]) title = soup.find('h1').getText() T = soup.find('time') Date = datetime.datetime.strptime(T['datetime'], \"%Y-%m-%dT%H:%M:%S+08:00\") return(Date,post_id,title,n_tags,text) for i in range(0,len(urls)): print(get_text(i)) ","date":"2021-02-01","objectID":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:3","tags":["Selenium","bs4","urllib","MongoDB"],"title":"TWSE [13] Selenium + 鉅亨網","uri":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"完整程式碼 import pymongo import urllib from bs4 import BeautifulSoup from selenium import webdriver from selenium.webdriver.chrome.options import Options import regex as re import datetime import time pause_time = 10 options = webdriver.ChromeOptions() options.add_experimental_option(\"prefs\", {'ignore_image': 2}) options.add_argument('--headless') options.add_argument('--disable-gpu') driver = webdriver.Chrome(chrome_options=options) driver.get(\"https://news.cnyes.com/news/cat/tw_stock_news?exp=a\") for i in range(2): driver.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\") time.sleep(pause_time) soup = BeautifulSoup(driver.page_source, 'html.parser') driver.close() hrefs = soup.find_all('a') post_ids = [] past_post_ids = [] new_post_ids = [] for href in hrefs: if re.match('/news/id/', str(href.get('href'))): post_id = str(href.get('href')).split('/')[-1].split('?')[0] post_ids.append(post_id) myclient = pymongo.MongoClient(\"mongodb://localhost:27017/\") mydb = myclient[\"article\"] mycol = mydb[\"2021_鉅亨網\"] end = datetime.datetime.now() start = end - datetime.timedelta(days = 3) for x in mycol.find({'Date': {\"$gte\": start,\"$lte\": end}}): past_post_ids.append(x[\"post_id\"]) new_post_ids = [] for _id in post_ids: if _id in past_post_ids: None else: new_post_ids.append(_id) urls = ['https://news.cnyes.com/news/id/{}?exp=a'.format(e) for e in new_post_ids] def get_text(i): post_id = urls[i].split('/')[5].split('?')[0] data = urllib.request.urlopen(urls[i]) soup = BeautifulSoup(data, 'html.parser') P = soup.find_all('p') text = '' for i,p in zip(range(0,len(P)),P): if i \u003e=4: text = text + p.getText() i += 1 tags = soup.find_all('a') n_tags = [] for tag in tags: if re.match('/tag/', str(tag.get('href'))): n_tags.append(str(tag.get('href'))[5:len(str(tag.get('href')))]) title = soup.find('h1').getText() T = soup.find('time') Date = datetime.datetime.strptime(T['datetime'], \"%Y-%m-%dT%H:%M:%S+08:00\") return(Date,post_id,title,n_tags,text) for i in range(0,len(urls)): data = get_text(i) print(i, end = ' ') mydict = { \"Date\": data[0], \"post_id\":data[1],\"Title\": data[2], \"Tags\":data[3] , \"text\": data[4] } x = mycol.insert_one(mydict) cursor = mycol.aggregate( [{\"$group\": {\"_id\": \"$Title\", \"unique_ids\": {\"$addToSet\": \"$_id\"}, \"count\": {\"$sum\": 1}}}, {\"$match\": {\"count\": { \"$gte\": 2 }}}]) response = [] for doc in cursor: del doc[\"unique_ids\"][0] for id in doc[\"unique_ids\"]: response.append(id) mycol.remove({\"_id\": {\"$in\": response}}) ","date":"2021-02-01","objectID":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:4","tags":["Selenium","bs4","urllib","MongoDB"],"title":"TWSE [13] Selenium + 鉅亨網","uri":"/twse-13-selenium-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com Python + 投資學/Efficient Frontier/ ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:0:0","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"SQL 連接/方法一/ from sqlalchemy import create_engine import pandas as pd import matplotlib import matplotlib.pyplot as plt %matplotlib inline import numpy as np from functools import reduce import scipy.optimize as solver user = 'root' pw = \"YourPassword\" db = \"TWSE\" engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=db)) df_2330 = pd.read_sql(\"SELECT * FROM `每日收盤行情` WHERE `證券代號` = 2330 AND `日期` BETWEEN '2020/10/20 00:00:00' AND '2021/1/10 23:59:59' ORDER BY `日期`\", engine, coerce_float=True, parse_dates=True) df_tw = pd.read_sql(\"SELECT * FROM `發行量加權股價指數` WHERE `日期` BETWEEN '2020/10/20 00:00:00' AND '2021/1/10 23:59:59'\", engine, coerce_float=True, parse_dates=True) ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:0","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"報酬率 參考資料\r\rpandas.DataFrame.pct_change $$ Return = \\frac{D_{1} - D_{0}}{D_{0}} $$\r\r 基本 今日 \u0026 昨日 print('今日 昨日') for i,j in zip(df_2330['收盤價'],df_2330['收盤價'].shift(1)) : print(i, j) Return = pd.DataFrame((df_2330['收盤價'] - df_2330['收盤價'].shift(1))/df_2330['收盤價'].shift(1)) Return = Return.rename(columns = {'收盤價':'Return'}) Return pct_change() df_2330['收盤價'].pct_change() df_tw['收盤指數'].pct_change() df = pd.DataFrame(df_2330['收盤價'].pct_change()) df['TW'] = df_tw['收盤指數'].pct_change() df = df.rename(columns = {'收盤價':'2330'}) ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:1","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"變異數$σ^2$ var() df_tw['收盤指數'].pct_change().var() ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:2","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"標準差$σ$ std() df_tw['收盤指數'].pct_change().std() std = df_tw['收盤指數'].pct_change().var()**(1/2) ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:3","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"共變異數$σ_{a,b}$ cov() 參考公式\r\r$$cov_{x,y} = \\frac{\\sum{}^{} ({x_i} - \\overline{x})({y_i} - \\overline{y})}{N-1}$$\r\r 簡單實證 df_test = pd.DataFrame([(1, 2), (0, 3), (2, 0), (1, 1)], columns=['dogs', 'cats']) df_test.cov() $$dog$$ $$dog_i - \\overline{dog} $$ $$cats$$ $$cat_i - \\overline{cat} $$ $${Dev_{dog}}\\times{Dev_{cat}}$$ 1 0 2 1 0 0 -1 3 1.5 -1.5 2 1 0 -1.5 -1.5 1 0 1 -1 0 $$\\overline{dog} = 1$$ $$\\overline{cat} = 1.5$$ $${\\frac{\\sum{}^{} ({Dev_{dog}}\\times{Dev_{cat}})}{4-1}} = -1$$ $ σ_{2330,TW} $ 補充資料\r\r$$ σ_{2330,TW} $$ Excel計算過程\r\r df.cov() \u003e\u003e\u003e 0.000097 ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:4","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"相關係數$ρ_{a,b}$ corr() df.corr() 2330 TW 2330 1.000000 0.895857 TW 0.895857 1.000000 ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:5","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"$\\beta$係數 參考公式\r\r$${\\beta} = \\frac{σ_{i,m}}{σ^2}$$ \r\r Beta = df.cov()['TW'][0]/df_tw['收盤指數'].pct_change().var() ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:1:6","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"SQL 連接/方法二/ from sqlalchemy import create_engine import pandas as pd import matplotlib import matplotlib.pyplot as plt %matplotlib inline import numpy as np from functools import reduce import scipy.optimize as solver user = 'root' pw = \"YourPassword\" db = \"TWSE\" engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=db)) Start = '2020/10/20 00:00:00' End = '2021/1/10 23:59:59' SQL = ''' SELECT `收盤價` FROM `{}` WHERE `證券代號` = '{}' AND `日期` BETWEEN '{}' AND '{}' ORDER BY `日期` ''' stock_codes = ['2330','2317','1234'] def getSQL(stock_code): df = pd.read_sql(SQL.format('每日收盤行情',stock_code, Start, End), engine, coerce_float=True, parse_dates=True) return df def Tsql(stock_codes): for i in range(0,len(stock_codes)): globals()[i] = getSQL(stock_codes[i]) if i == 0: df = pd.DataFrame(globals()[i].pct_change()) df = df.rename(columns = {'收盤價':stock_codes[i]}) else: df['{}'.format(stock_codes[i])] = globals()[i].pct_change() df = df.replace([np.inf, -np.inf], 0) return df returns = Tsql(stock_codes) ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:2:0","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"預期報酬$E(r)$ Expected_R = returns.mean() * 252 ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:2:1","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"權重$W_{i}$ W = np.array([0.5,0.3,0.2]) ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:2:2","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"投資組合報酬率$R_{P}$ 參考公式\r\r$$R_{P} = \\sum{W_{i}\\times{R_{i}}}$$\r\r Portfolio_R = sum(W * Expected_R) ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:2:3","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"量化投資/Efficient Frontier/ ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:0","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"隨機權重$W_{i}$ W = np.random.rand(len(stock_codes)) W = W/sum(W) W ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:1","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"投資組合風險$σ_{P}^2$ 基本公式 參考公式\r\r$$σ_{P}^2 = \\sum{ {W_{i}^2} {σ_{i}^2}} + \\sum\\sum{ W_{i} W_{j} {σ_{i,j}} } $$ $$σ_{P}^2 = \\sum{ {W_{i}^2} {σ_{i}^2}} + \\sum\\sum{ W_{i} W_{j} {ρ_{i,j}} {σ_{i}} {σ_{j}} } $$\r\r 矩陣簡單計算 參考資料\r\r[work] 理解矩陣乘法 \\[ \\begin{bmatrix} 1\u00262\\\\3\u00264 \\end{bmatrix} \\times \\begin{bmatrix} 4\u0026-6\\\\ -2\u00263 \\end{bmatrix} = \\begin{bmatrix} A_1\u0026A_2\\\\B_1\u0026B_2 \\end{bmatrix} = \\begin{bmatrix} 0\u00260\\\\4\u0026 -6 \\end{bmatrix}\\]\r\r $A_{1} = 1\\times4 + 2\\times(-2) = 0$ $A_{2} = 1\\times(-6) + 2\\times(3) = 0$ $B_{1} = 3\\times4 + 4\\times(-2) = 4$ $B_{2} = 3\\times(-6) + 4\\times(3) = -6$ 使用矩陣簡化$σ_{P}^2$計算 參考資料\r\rVaR 風險值衡量(Value at Risk；VaR) 如何計算投資組合的風險和回報 $$σ_{P}^2 = \\begin{bmatrix}W_1\u0026W_2\u0026W_3\\end{bmatrix} \\times \\begin{bmatrix}σ_{1}^2\u0026σ_{2,1}\u0026σ_{3,1} \\\\\\ σ_{1,2}\u0026σ_{2}^2\u0026σ_{3,2} \\\\\\ σ_{1,3}\u0026σ_{2,3}\u0026σ_{3}^2\\end{bmatrix} \\times \\begin{bmatrix}W_1\\\\\\ W_2\\\\\\ W_3\\end{bmatrix}$$ \r\r .tg {border-collapse:collapse;border-spacing:0;} .tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px; overflow:hidden;padding:10px 5px;word-break:normal;} .tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px; font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;} .tg .tg-io4b{background-color:#efefef;border-color:inherit;color:#000000;font-weight:bold;text-align:center;vertical-align:top} .tg .tg-c3ow{border-color:inherit;text-align:center;vertical-align:top} .tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top} 步驟一 $$\\begin{bmatrix}W_1\u0026W_2\u0026W_3\\end{bmatrix} \\times \\begin{bmatrix}σ_{1}^2\u0026σ_{2,1}\u0026σ_{3,1} \\\\\\ σ_{1,2}\u0026σ_{2}^2\u0026σ_{3,2} \\\\\\ σ_{1,3}\u0026σ_{2,3}\u0026σ_{3}^2\\end{bmatrix}$$ $W_{1}σ_{1}^2 + W_{2}σ_{1,2}+ W_{3}σ_{1,3}$ $ W_{1}σ_{2,1}+ W_{2}σ_{2}^2+ W_{3}σ_{2,3}$ $ W_{1}σ_{3,1}+ W_{2}σ_{3,2}+ W_{3}σ_{3}^2$ 步驟二 $$\\begin{bmatrix} W_{1}σ_{1}^2 + W_{2}σ_{1,2}+ W_{3}σ_{1,3},\u0026 W_{1}σ_{2,1}+ W_{2}σ_{2}^2+ W_{3}σ_{2,3},\u0026 W_{1}σ_{3,1}+ W_{2}σ_{3,2}+ W_{3}σ_{3}^2\\end{bmatrix} \\times \\begin{bmatrix}W_1\\\\\\ W_2\\\\\\ W_3\\end{bmatrix}$$ $W_{1}^2σ_{1}^2$ $ W_{1}W_{2}σ_{2,1}$ $ W_{1}W_{2}σ_{3,1}$ $ W_{1} W_{2}σ_{1,2}$ $ W_{2}^2σ_{2}^2$ $ W_{2}W_{3}σ_{3,2}$ $ W_{1} W_{3}σ_{1,3}$ $ W_{2}W_{3}σ_{2,3}$ $ W_{3}^2σ_{3}^2$ 用Python表示 參考資料\r\rPython-繪製效率前緣(Efficient Frontier) Python金融大數據分析——第11章 統計學（2）投資組合優化 筆記\r\r 方法一 以下程式碼來源，參考自：\r\rPython-繪製效率前緣(Efficient Frontier) Portfolio_risk = np.sqrt(reduce(np.dot, [W, cov_matrix, W.T])) \r\r 方法二 參考資料\r\rPython Lambda Portfolio_risk = lambda a, b,c: np.sqrt(np.dot(np.dot(a,b),c)) Portfolio_risk(W, cov_matrix,W.T) \r\r ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:2","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"隨機生成10000筆權重 以下程式碼來源，參考自：\r\rPython-繪製效率前緣(Efficient Frontier) Expected_R = returns.mean() * 252 cov_matrix = returns.cov()*252 all_Portfolio_risk = [] all_return = [] Expected_R = returns.mean() * 252 stop = 0 while stop \u003c 10000: try: stop += 1 W = np.random.rand(len(stock_codes)) W = W/sum(W) all_return.append(sum(Expected_R * W)) all_Portfolio_risk.append(np.sqrt(reduce(np.dot, [W, cov_matrix, W.T]))) except: pass SR = np.array(all_return)/np.array(all_Portfolio_risk) \r\r 畫圖 Fig 1 fig = plt.figure(figsize = (20,10)) ax = fig.add_subplot() ax.plot(all_Portfolio_risk, all_return, 'o',alpha=1) fig.savefig('Efficient_Frontier_1.png',dpi=300, bbox_inches='tight') Fig 2 方法一 #基本設定 fig = plt.figure(figsize = (20,8)) risk_free = 0.01 SR = (np.array(all_return)-risk_free)/np.array(all_Portfolio_risk) #字體大小設定 label_size = 27 tick_size = 15 Title_size = 40 #Title Title = 'Efficient Frontier' #格線 plt.grid(True) #散點圖 plt.scatter(all_Portfolio_risk, all_return, c=SR,alpha=1) #X,Y軸標籤 plt.xlabel('$σ_{P}$', fontsize=label_size, fontweight='bold') plt.ylabel('$E(R)$', fontsize=label_size, fontweight='bold') #X,Y軸字體設定 plt.xticks(fontsize=tick_size, fontweight='bold') plt.yticks(fontsize=tick_size, fontweight='bold') #color bar設定 cbar = plt.colorbar(label='$Sharpe$ $Ratio$') ax = cbar.ax ax.tick_params(labelsize=tick_size) cbar_Title = ax.yaxis.label font = matplotlib.font_manager.FontProperties(size=label_size) cbar_Title.set_font_properties(font) plt.title(Title, fontsize=Title_size,family = 'monospace',ha = 'center') #圖片儲存 plt.savefig('Efficient_Frontier_2.png',dpi=300, bbox_inches='tight') 方法二 fig = plt.figure(figsize = (20,8)) label_size = 27 tick_size = 15 Title_size = 40 Title = 'Efficient Frontier' risk_free = 0.01 SR = (np.array(all_return)-risk_free)/np.array(all_Portfolio_risk) ax = fig.add_subplot() ax.grid(True) ax_main = ax.scatter(all_Portfolio_risk, all_return, c=SR,alpha=1) ax.set_title(Title, fontsize=Title_size,family = 'monospace',ha = 'center') ax.set_xlabel('$σ_{P}$', fontsize=label_size, fontweight='bold') ax.set_ylabel('$E(R)$', fontsize=label_size, fontweight='bold') ax.tick_params(labelsize=tick_size) cbar = fig.colorbar(ax_main, ax=ax, label = '$Sharpe$ $Ratio$') cbar = cbar.ax cbar.tick_params(labelsize=tick_size) cbar_Title = cbar.yaxis.label font = matplotlib.font_manager.FontProperties(size=label_size) cbar_Title.set_font_properties(font) fig.savefig('Efficient_Frontier_3.png',dpi=300, bbox_inches='tight') ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:3","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"scipy.optimize.minimize min($σ_{P}$) def standard_deviation(W): return Portfolio_risk(W, cov_matrix,W.T) 以下程式碼來源，參考自：\r\rPython-繪製效率前緣(Efficient Frontier) x0 = [1/len(stock_codes) for e in range(len(stock_codes))] bounds = tuple((0, 1) for x in range(len(stock_codes))) constraints = [{'type': 'eq', 'fun': lambda x: sum(x) - 1}] min_Portfolio_risk = solver.minimize(standard_deviation, x0=x0, constraints=constraints, bounds=bounds) mvp_risk = min_Portfolio_risk.fun mvp_return = sum(min_Portfolio_risk.x * Expected_R) print('風險最小化投資組合預期報酬率為:' + str(round(mvp_return,2))) print('風險最小化投資組合風險為:' + str(round(mvp_risk,2))) \r\r 補充資料\r\rscipy.optimize.minimize \r\r 以下程式碼來源，參考自：\r\rPython-繪製效率前緣(Efficient Frontier) for i in range(0,len(stock_codes)): print(stock_codes[i]+' 佔投資組合權重 : ' + str(format(min_Portfolio_risk.x[i], '.4f'))) $$SR = \\frac{R_{P} - R_{f}}{σ_{P}}$$ risk_free = 0.01 SR = (np.array(all_return)-risk_free)/np.array(all_Portfolio_risk) x0 = [1/len(stock_codes) for e in range(len(stock_codes))] bounds = tuple((0, 1) for x in range(len(stock_codes))) efficient_fronter_return_range = np.arange(min(all_return), max(all_return),(max(all_return) - min(all_return))/20) efficient_fronter_risk_list = [] for i in efficient_fronter_return_range: constraints = [{'type': 'eq', 'fun': lambda x: sum(x) - 1}, {'type': 'eq', 'fun': lambda x: sum(x * Expected_R) - i}] efficient_fronter = solver.minimize(standard_deviation, x0=x0, constraints=constraints, bounds=bounds) efficient_fronter_risk_list.append(efficient_fronter.fun) \r\r label_size = 27 tick_size = 15 Title_size = 40 Title = 'Efficient Frontier' fig = plt.figure(figsize = (20,8)) ax = fig.add_subplot() ax.grid(True) ax_main = ax.scatter(all_Portfolio_risk, all_return, c=SR,alpha=1) ax.set_title(Title, fontsize=Title_size,family = 'monospace',ha = 'center') ax.set_xlabel('$σ_{P}$', fontsize=label_size, fontweight='bold') ax.set_ylabel('$E(R)$', fontsize=label_size, fontweight='bold') ax.tick_params(labelsize=tick_size) ax.plot(efficient_fronter_risk_list, efficient_fronter_return_range, linewidth=5, color='#251f6b') ax.plot(mvp_risk, mvp_return,'o',color='r', markerfacecolor='#ed1313', markersize=15) cbar = fig.colorbar(ax_main, ax=ax, label = '$Sharpe$ $Ratio$') cbar = cbar.ax cbar.tick_params(labelsize=tick_size) cbar_Title = cbar.yaxis.label font = matplotlib.font_manager.FontProperties(size=label_size) cbar_Title.set_font_properties(font) fig.savefig('Efficient_Frontier_4.png',dpi=300, bbox_inches='tight') ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:4","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"完整程式碼/SQL/ from sqlalchemy import create_engine import pandas as pd import matplotlib import matplotlib.pyplot as plt %matplotlib inline import numpy as np from functools import reduce import scipy.optimize as solver user = 'root' pw = \"YourPassword\" db = \"TWSE\" engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=db)) Start = '2020/10/20 00:00:00' End = '2021/1/10 23:59:59' SQL = ''' SELECT `收盤價` FROM `{}` WHERE `證券代號` = '{}' AND `日期` BETWEEN '{}' AND '{}' ORDER BY `日期` ''' stock_codes = ['2330','2317','1234'] def getSQL(stock_code): df = pd.read_sql(SQL.format('每日收盤行情',stock_code, Start, End), engine, coerce_float=True, parse_dates=True) return df def Tsql(stock_codes): for i in range(0,len(stock_codes)): globals()[i] = getSQL(stock_codes[i]) if i == 0: df = pd.DataFrame(globals()[i].pct_change()) df = df.rename(columns = {'收盤價':stock_codes[i]}) else: df['{}'.format(stock_codes[i])] = globals()[i].pct_change() df = df.replace([np.inf, -np.inf,np.nan], 0) return df returns = Tsql(stock_codes) Expected_R = returns.mean() * 252 cov_matrix = returns.cov()*252 Portfolio_risk = lambda a, b,c: np.sqrt(np.dot(np.dot(a,b),c)) all_Portfolio_risk = [] all_return = [] stop = 0 while stop \u003c 10000: try: stop += 1 W = np.random.rand(len(stock_codes)) W = W/sum(W) all_return.append(sum(Expected_R * W)) all_Portfolio_risk.append(Portfolio_risk(W, cov_matrix,W.T)) except: pass def standard_deviation(W): return Portfolio_risk(W, cov_matrix,W.T) x0 = [1/len(stock_codes) for e in range(len(stock_codes))] bounds = tuple((0, 1) for x in range(len(stock_codes))) constraints = [{'type': 'eq', 'fun': lambda x: sum(x) - 1}] min_Portfolio_risk = solver.minimize(standard_deviation, x0=x0, constraints=constraints, bounds=bounds) mvp_risk = min_Portfolio_risk.fun mvp_return = sum(min_Portfolio_risk.x * Expected_R) print('風險最小化投資組合預期報酬率為:' + str(round(mvp_return,2))) print('風險最小化投資組合風險為:' + str(round(mvp_risk,2))) for i in range(0,len(stock_codes)): print(stock_codes[i]+' 佔投資組合權重 : ' + str(format(min_Portfolio_risk.x[i], '.4f'))) risk_free = 0.01 SR = (np.array(all_return)-risk_free)/np.array(all_Portfolio_risk) start = round(min(all_return),6) end = round(max(all_return),4) efficient_fronter_return_range = np.arange(start, end,(max(all_return) - min(all_return))/30) efficient_fronter_risk_list = [] for i in efficient_fronter_return_range: constraints = [{'type': 'eq', 'fun': lambda x: sum(x) - 1}, {'type': 'eq', 'fun': lambda x: sum(x * Expected_R) - i}] efficient_fronter = solver.minimize(standard_deviation, x0=x0, constraints=constraints, bounds=bounds) efficient_fronter_risk_list.append(efficient_fronter.fun) label_size = 27 tick_size = 15 Title_size = 40 Title = 'Efficient Frontier' fig = plt.figure(figsize = (20,8)) ax = fig.add_subplot() ax.grid(True) ax_main = ax.scatter(all_Portfolio_risk, all_return, c=SR,alpha=1) ax.set_title(Title, fontsize=Title_size,family = 'monospace',ha = 'center') ax.set_xlabel('$σ_{P}$', fontsize=label_size, fontweight='bold') ax.set_ylabel('$E(R)$', fontsize=label_size, fontweight='bold') ax.tick_params(labelsize=tick_size) ax.plot(efficient_fronter_risk_list, efficient_fronter_return_range, linewidth=5, color='#251f6b') ax.plot(mvp_risk, mvp_return,'o',color='r', markerfacecolor='#ed1313', markersize=15) cbar = fig.colorbar(ax_main, ax=ax, label = '$Sharpe$ $Ratio$') cbar = cbar.ax cbar.tick_params(labelsize=tick_size) cbar_Title = cbar.yaxis.label font = matplotlib.font_manager.FontProperties(size=label_size) cbar_Title.set_font_properties(font) fig.savefig('Efficient_Frontier_4.png',dpi=300, bbox_inches='tight') ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:5","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"完整程式碼/免SQL/ import pandas_datareader.data as web import mplfinance as mpf import matplotlib import matplotlib.pyplot as plt %matplotlib inline import numpy as np import scipy.optimize as solver stock_code = ['2330','3008','6409','1234','2337','2412'] stock_codes = ['{}.tw'.format(e) for e in stock_code] df = web.DataReader(stock_codes, 'yahoo', '2020-05-01') returns = df['Close'].pct_change() Expected_R = returns.mean() * 252 cov_matrix = returns.cov()*252 Portfolio_risk = lambda a, b,c: np.sqrt(np.dot(np.dot(a,b),c)) all_Portfolio_risk = [] all_return = [] stop = 0 while stop \u003c 50000: try: stop += 1 W = np.random.rand(len(stock_codes)) W = W/sum(W) all_return.append(sum(Expected_R * W)) all_Portfolio_risk.append(Portfolio_risk(W, cov_matrix,W.T)) except: pass def standard_deviation(W): return Portfolio_risk(W, cov_matrix,W.T) x0 = [1/len(stock_codes) for e in range(len(stock_codes))] bounds = tuple((0, 1) for x in range(len(stock_codes))) constraints = [{'type': 'eq', 'fun': lambda x: sum(x) - 1}] min_Portfolio_risk = solver.minimize(standard_deviation, x0=x0, constraints=constraints, bounds=bounds) mvp_risk = min_Portfolio_risk.fun mvp_return = sum(min_Portfolio_risk.x * Expected_R) print('風險最小化投資組合預期報酬率為:' + str(round(mvp_return,2))) print('風險最小化投資組合風險為:' + str(round(mvp_risk,2))) for i in range(0,len(stock_codes)): print(stock_codes[i]+' 佔投資組合權重 : ' + str(format(min_Portfolio_risk.x[i], '.4f'))) risk_free = 0.01 SR = (np.array(all_return)-risk_free)/np.array(all_Portfolio_risk) start = round(min(all_return),6) end = round(max(all_return),4) efficient_fronter_return_range = np.arange(start, end,(max(all_return) - min(all_return))/30) efficient_fronter_risk_list = [] for i in efficient_fronter_return_range: constraints = [{'type': 'eq', 'fun': lambda x: sum(x) - 1}, {'type': 'eq', 'fun': lambda x: sum(x * Expected_R) - i}] efficient_fronter = solver.minimize(standard_deviation, x0=x0, constraints=constraints, bounds=bounds) efficient_fronter_risk_list.append(efficient_fronter.fun) label_size = 27 tick_size = 15 Title_size = 40 Title = 'Efficient Frontier' fig = plt.figure(figsize = (20,8)) ax = fig.add_subplot() ax.grid(True) ax_main = ax.scatter(all_Portfolio_risk, all_return, c=SR,alpha=1) ax.set_title(Title, fontsize=Title_size,family = 'monospace',ha = 'center') ax.set_xlabel('$σ_{P}$', fontsize=label_size, fontweight='bold') ax.set_ylabel('$E(R)$', fontsize=label_size, fontweight='bold') ax.tick_params(labelsize=tick_size) ax.plot(efficient_fronter_risk_list, efficient_fronter_return_range, linewidth=5, color='#251f6b') ax.plot(mvp_risk, mvp_return,'o',color='r', markerfacecolor='#ed1313', markersize=15) cbar = fig.colorbar(ax_main, ax=ax, label = '$Sharpe$ $Ratio$') cbar = cbar.ax cbar.tick_params(labelsize=tick_size) cbar_Title = cbar.yaxis.label font = matplotlib.font_manager.FontProperties(size=label_size) cbar_Title.set_font_properties(font) fig.savefig('Efficient_Frontier_4.png',dpi=300, bbox_inches='tight') ","date":"2021-01-27","objectID":"/twse-12-efficient-frontier/:3:6","tags":["Python","TWSE","Pandas"],"title":"TWSE [12] Efficient Frontier","uri":"/twse-12-efficient-frontier/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com Wordcloud + MongoDB ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:0:0","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"img wordcloud.jpg ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:1:0","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"MongoDB連線 myclient = pymongo.MongoClient(\"mongodb://localhost:27017/\") mydb = myclient[\"article\"] mycol = mydb[\"2021_鉅亨網\"] ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:0","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"import %matplotlib inline import matplotlib.pyplot as plt from wordcloud import WordCloud from PIL import Image import numpy as np import jieba import nltk import pymongo ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:1","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"抓出文章內容 Text = \"\" for x in mycol.find({}): Text = Text + x[\"text\"] ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:2","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"Wordcloud圖 mask = np.array(Image.open('wordcloud.jpg')) wordcloud = WordCloud(background_color=\"white\", width=1000, height=860, margin=2, font_path=\"msjhbd.ttc\", mask=mask).generate(Text) plt.figure(figsize=(20,20)) plt.imshow(wordcloud) plt.axis(\"off\") plt.show() fig 1 fig 2 存到了一些無關緊要的資料 重複性高的開頭、形容詞 ex: 其中、今年、不過、另外...... ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:3","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"將符號移除 Text = Text.translate({ord(c):None for c in list(\"(),.“”（）「」，。、：；！|\\n/ 《》〔〕〈〉？\")}) ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:4","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"自建詞 userdict userdict.txt jieba.load_userdict(\"userdict.txt\") ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:5","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"中文斷詞 jieba terms = jieba.cut(Text) ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:6","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"停用詞 stopwords.txt stopwords.txt stopwords = list() with open(\"stopwords.txt\", \"r\", encoding = \"utf-8\") as fp: stopwords = [word.strip() for word in fp.readlines()] keyterms = [keyterm for keyterm in terms if keyterm not in stopwords] Text = \"/\".join(keyterms) ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:7","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"WordCloud圖 mask = np.array(Image.open('wordcloud.jpg')) wordcloud = WordCloud(background_color=\"white\", width=1000, height=860, margin=2, font_path=\"msjhbd.ttc\", mask=mask).generate(Text) plt.figure(figsize=(20,20)) plt.imshow(wordcloud) plt.axis(\"off\") plt.show() ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:2:8","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"讀取txt檔 ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:3:0","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"import %matplotlib inline import matplotlib.pyplot as plt from wordcloud import WordCloud from PIL import Image import numpy as np import jieba import nltk ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:3:1","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"Read *.txt test_text.txt with open(\"test_text.txt\", \"r\", encoding = \"utf-8\") as fp: Text = fp.read() ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:3:2","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"畫圖 Text = Text.translate({ord(c):None for c in list(\"(),.“”（）「」，。、：；！|\\n/ 《》〔〕〈〉？\")}) jieba.load_userdict(\"userdict.txt\") terms = jieba.cut(Text) stopwords = list() with open(\"stopwords.txt\", \"r\", encoding = \"utf-8\") as fp: stopwords = [word.strip() for word in fp.readlines()] keyterms = [keyterm for keyterm in terms if keyterm not in stopwords] Text = \"/\".join(keyterms) mask = np.array(Image.open('wordcloud.jpg')) wordcloud = WordCloud(background_color=\"white\", width=1000, height=860, margin=2, font_path=\"msjhbd.ttc\", mask=mask).generate(Text) plt.figure(figsize=(20,20)) plt.imshow(wordcloud) plt.axis(\"off\") plt.show() ","date":"2021-01-26","objectID":"/twse-11-wordcloud-mongodb/:3:3","tags":["Python","TWSE","MongoDB","NoSQL","Word Cloud"],"title":"TWSE [11] Wordcloud + MongoDB","uri":"/twse-11-wordcloud-mongodb/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com NoSQL MonogoDB + Python ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:0:0","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"MonogoDB Download 參考資料 Windows MongoDB 下載與安裝教學 關於 MongoDB 的 _id 欄位 MongoDB的_id和ObjectId怎麼理解？同樣是程式設計師，用心你就超前了 MongoDB Data Types ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:1:0","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"MongoDB Version db.version() \u003e\u003e\u003e 4.4.2 ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:1:1","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"MongoDB Data Types MongoDB Data Types Integer Arrays Timestamp Boolean Object Binary data Double Symbol Object ID Min/Max keys Null Regular expression String Date Code ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:1:2","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"Robo 3T Download 參考資料 MongoDB 使用Robo 3T建立資料庫 ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:2:0","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"Python ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:3:0","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"w3schools 1 pip install pip install pymongo 2 import import pymongo myclient = pymongo.MongoClient(\"mongodb://localhost:27017/\") 3 測試用文章 #測試文章 title = '盤中零股交易台積電最受歡迎 成交金額逼近200億元' text = '''台股攻上波段新高，連帶掀起零股交易熱潮，根據證交所統計，盤中零股交易自去年 10 月 26 日實施以來，截至今年 1 月 15 日止，單日平均成交金額達 8.73 億元，加上盤後交易，單日平均金額超過 10 億元，其中權值股王台積電 (2330-TW) 累計成交值逼近 200 億元，是最熱門的交易標的。根據證交所統計，盤中零股交易前 10 大熱門標首推台積電，交易金額比重高達 34%，其次分別為：大立光 (3008-TW)(12%)、聯發科 (2454-TW)(5%)、國巨 (2327-TW)(3%)、元大台灣 50(2%)、鴻海 (2317-TW)(2%)；另外，聯電 (2303-TW)、台達電 (2308-TW)、玉晶光 (3406-TW)、同欣電 (6271-TW) 交易金額也有 1% 的比重。以成交股數來看，台積電以占整體交易比重 8% 居冠，其他依序分別為：聯電、鴻海、元大高股息、玉山金 (2884-TW)、元大台灣 50、長榮、元晶、敦泰與第一金。以台積電來說，假設投資人在 10 月 26 日當天高點 455 元買進台積電續抱至今，以今天收盤價 627 元計算，期間股價約上漲 37%，其他包括聯電、鴻海股價在期間攻上歷史高點，同樣讓零股投資人賺進一筆收益。''' 4 Create DB, Collection and Insert document mydb = myclient[\"article\"] mycol = mydb[\"test\"] mydict = { \"Title\": title, \"text\": text } x = mycol.insert_one(mydict) 5 印出所有DB print(myclient.list_database_names()) 6 印出所有collection print(mydb.list_collection_names()) ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:3:1","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"Python + bs4 + 鉅亨網 1 def get_text(i): def get_text(i): post_id = urls[i].split('/')[5].split('?')[0] data = urllib.request.urlopen(urls[i]) soup = BeautifulSoup(data, 'html.parser') P = soup.find_all('p') text = '' for i,p in zip(range(0,len(P)),P): if i \u003e=4: text = text + p.getText() i += 1 tags = soup.find_all('a') n_tags = [] for tag in tags: if re.match('/tag/', str(tag.get('href'))): n_tags.append(str(tag.get('href'))[5:len(str(tag.get('href')))]) title = soup.find('h1').getText() T = soup.find('time') Date = datetime.datetime.strptime(T['datetime'], \"%Y-%m-%dT%H:%M:%S+08:00\") return(Date,post_id,title,n_tags,text) 2 import套件 import pymongo import urllib from bs4 import BeautifulSoup import regex as re import datetime 3 Create DB, Collection myclient = pymongo.MongoClient(\"mongodb://localhost:27017/\") mydb = myclient[\"article\"] mycol = mydb[\"2021_鉅亨網\"] 4 Insert document url = 'https://news.cnyes.com/news/cat/tw_stock_news?exp=a' data = urllib.request.urlopen(url) soup = BeautifulSoup(data, 'html.parser') hrefs = soup.find_all('a') urls = ['https://news.cnyes.com'+ str(href.get('href')) for href in hrefs if re.match('/news/id/', str(href.get('href')))] for i in range(0,len(urls)): data = get_text(i) mydict = { \"Date\": data[0], \"post_id\":data[1],\"Title\": data[2], \"Tags\":data[3] , \"text\": data[4] } x = mycol.insert_one(mydict) 5 find 參考資料 Tutorial — PyMongo v2.0.1 documentation w3schools Collection Methods Finding duplicate keys with MongoDB’s aggregation framework find({}) 全部 for x in mycol.find({}): print(x) find({}).count() 計算全部數量 mycol.find({}).count() find({“X”:“XX”}) 特定資料 for x in mycol.find({\"Title\":\"宏泰人壽減資再增資 丟包袱223.9億元補虧損 2月底前現增19.5億元\"}): print(x) find({“X”: {\"$\u001elt\": X}}).sort(“XX”) 指定日期之前的所有資料.sort(“Date”) d = datetime.datetime(2021, 1, 21, 23) Year Month Day Hour 2021 1 21 23（整天） ★hour must be in 0~23 d = datetime.datetime(2021, 1, 21, 23) for x in mycol.find({\"Date\": {\"$lt\": d}}).sort(\"Date\"): print(x) print(mycol.find({\"Date\": {\"$lt\": d}}).sort(\"Date\").count()) find({‘Date’: {\"$\u001egte\": start,\"$\u001elte\": end}}) 找出一段時間的資料 start = datetime.datetime(2021, 1, 21, 0) end = datetime.datetime(2021, 1, 22, 20) for x in mycol.find({'Date': {\"$gte\": start,\"$lte\": end}}).sort(\"Date\"): print(x) 6 刪除重複資料 參考資料 mongo 删除重复数据 pymongo去除重复数据 pymongo: remove duplicates (map reduce?) MongoDB執行 準備重複資料 執行程式碼/SQL/ db.getCollection(\"test\").aggregate([ { $group:{_id:{Title:'$Title'},count:{$sum:1},dups:{$addToSet:'$_id'}} }, { $match:{count:{$gt:1}} } ]).forEach(function(it){ it.dups.shift(); db.getCollection(\"test\").remove({_id: {$in: it.dups}}); });db.getCollection(\"test\").aggregate([ { $group:{_id:{Title:'$Title'},count:{$sum:1},dups:{$addToSet:'$_id'}} }, { $match:{count:{$gt:1}} } ]).forEach(function(it){ it.dups.shift(); db.getCollection(\"test\").remove({_id: {$in: it.dups}}); }); Python執行 準備重複資料 for i in range(10): mydict = { \"Title\": title, \"text\": text } x = mycol.insert_one(mydict) 執行程式碼/Python/ cursor = mycol.aggregate( [ {\"$group\": {\"_id\": \"$Title\", \"unique_ids\": {\"$addToSet\": \"$_id\"}, \"count\": {\"$sum\": 1}}}, {\"$match\": {\"count\": { \"$gte\": 2 }}} ] ) response = [] for doc in cursor: del doc[\"unique_ids\"][0] for id in doc[\"unique_ids\"]: response.append(id) mycol.remove({\"_id\": {\"$in\": response}}) 7 $orderby 參考資料 $orderby cursor.sort() 先複製collection，避免出錯 不改變原始資料 執行程式碼/SQL/ db.getCollection('2021_鉅亨網_copy').find().sort( { Date: -1 } ) If MongoDB requires using more than 100 megabytes of system memory for the blocking sort operation, MongoDB returns an error unless the query specifies cursor.allowDiskUse() (New in MongoDB 4.4). allowDiskUse() allows MongoDB to use temporary files on disk to store data exceeding the 100 megabyte system memory limit while processing a blocking sort operation. 原文參考自： $orderby 執行程式碼/Python/ for x in mycol.find({}).sort(\"Date\"): print(x) ","date":"2021-01-19","objectID":"/twse-10-mongodb-python/:3:2","tags":["Python","TWSE","MongoDB","NoSQL"],"title":"TWSE [10] MongoDB+Python","uri":"/twse-10-mongodb-python/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com BeautifulSoup + 鉅亨網 import urllib from bs4 import BeautifulSoup url = 'https://news.cnyes.com/news/cat/tw_stock_news?exp=a' data = urllib.request.urlopen(url) soup = BeautifulSoup(data, 'html.parser') ","date":"2021-01-19","objectID":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/:0:0","tags":["bs4","BeautifulSoup","urllib","html.parser"],"title":"TWSE [9] Bs4 + 鉅亨網","uri":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"原始碼 print(soup) ","date":"2021-01-19","objectID":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:0","tags":["bs4","BeautifulSoup","urllib","html.parser"],"title":"TWSE [9] Bs4 + 鉅亨網","uri":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"文章網址 找到 \u003ca\u003e...\u003c/a\u003e hrefs = soup.find_all('a') regex import regex as re for href in hrefs: if re.match('/news/id/', str(href.get('href'))): print('https://news.cnyes.com'+ str(href.get('href'))) 多個URL存成List urls = ['https://news.cnyes.com'+ str(href.get('href')) for href in hrefs if re.match('/news/id/', str(href.get('href')))] ","date":"2021-01-19","objectID":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:1","tags":["bs4","BeautifulSoup","urllib","html.parser"],"title":"TWSE [9] Bs4 + 鉅亨網","uri":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["Python","TWSE"],"content":"多個URL的文章解析 data = urllib.request.urlopen(urls[0]) soup = BeautifulSoup(data, 'html.parser') 找出文章的標題 找到\u003ch1\u003e...\u003c/h1\u003e title = soup.find('h1').getText() 找出文章的tags 找到 \u003ca\u003e...\u003c/a\u003e tags = soup.find_all('a') for tag in tags: print(tag) tags = soup.find_all('a') for tag in tags: print(tag.get('href')) for tag in tags: if re.match('/tag/', str(tag.get('href'))): print(str(tag.get('href'))[5:len(str(tag.get('href')))]) tags存成list n_tags = [] for tag in tags: if re.match('/tag/', str(tag.get('href'))): n_tags = n_tags.append(str(tag.get('href'))[5:len(str(tag.get('href')))]) 文章內文 找到 \u003cp\u003e...\u003c/p\u003e P = soup.find_all('p') print(P) 取\u003cp\u003e...\u003c/p\u003e的內文 for p in P: print(p.getText()) for i,p in zip(range(0,len(P)),P): if i \u003e=4: print(p.getText()) i += 1 包裝成def def get_text(i): data = urllib.request.urlopen(urls[i]) soup = BeautifulSoup(data, 'html.parser') P = soup.find_all('p') text = '' for i,p in zip(range(0,len(P)),P): if i \u003e=4: text = text + p.getText() i += 1 tags = soup.find_all('a') n_tags = [] for tag in tags: if re.match('/tag/', str(tag.get('href'))): n_tags.append(str(tag.get('href'))[5:len(str(tag.get('href')))]) title = soup.find('h1').getText() return(title,n_tags,text) ","date":"2021-01-19","objectID":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/:1:2","tags":["bs4","BeautifulSoup","urllib","html.parser"],"title":"TWSE [9] Bs4 + 鉅亨網","uri":"/twse-9-bs4-%E9%89%85%E4%BA%A8%E7%B6%B2/"},{"categories":["TWSE"],"content":"Freepik from www.flaticon.com plotly | Chart Studio ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:0:0","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"每日收盤行情 ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:0","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"1 註冊帳號 ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:1","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"2 點選SQL Query ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:2","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"3 下載Falcon SQL Client ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:3","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"4 登入SQL 輸入MySQL的帳號, 密碼 ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:4","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"5 點選QUERY 確認有確實讀到資料庫 ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:5","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"6 點選SCHEDULE 1 點選 Connect to / Chart Studio Enterprise / 2 Your Chart Studio Enterprise Domain / https://api.plot.ly / ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:6","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"7 Authorize ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:7","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"8 點選QUERY SELECT `日期`,`成交股數`,`開盤價`,`最高價`,`最低價`,`收盤價`,`color` FROM `每日收盤行情` WHERE `證券代號` = 2330 ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:8","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"9 選擇要多久跑一次 ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:9","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":["TWSE"],"content":"10 點選Live DataSet ","date":"2021-01-16","objectID":"/twse-8-chartstudio-1/:1:10","tags":["TWSE","Plotly","Chart Studio"],"title":"TWSE [8] plotly | Chart Studio | 1","uri":"/twse-8-chartstudio-1/"},{"categories":null,"content":" HJL Education Experience 1.     KFHS AFL   2015.9~2018.6   2.     NKUST DMB   2018.9~now   Skills Achievements 1.    Python   2.    SQL   3.    Financial Management   ","date":"2021-01-16","objectID":"/resume/:0:0","tags":["About me"],"title":"About me","uri":"/resume/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com Interactive Candlestick Charts ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:0:0","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Plotly pip install plotly ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:1:0","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊 ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:2:0","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"SQL連線 user = 'root' pw = \"YourPassworrd\" db = \"STOCK\" engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=db)) df = pd.read_sql(\"SELECT* FROM `twse` WHERE `Stock Code` = 2330 \", engine, coerce_float=True, parse_dates=True) df = df.drop(columns = ['Stock Code','Change','Transaction','Trade Value']) df = df.rename(columns = {'Opening Price': 'Open','Highest Price':'High','Closing Price':'Close', 'Lowest Price':'Low','Closing Price':'Close','Trade Volume':'Volume'}) ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:2:1","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Fig1 Basic fig = go.Figure(data=[go.Candlestick(x=df['Date'], open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'])]) fig.write_html(r\"C:\\Users\\User\\Downloads\\Python\\1.html\") fig.show() fig.show() ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:2:2","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Fig2 xaxis_rangeslider_visible=False fig = go.Figure(data=[go.Candlestick(x=df['Date'], open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'])]) fig.update_layout(xaxis_rangeslider_visible=False) fig.write_html(r\"C:\\Users\\User\\Downloads\\Python\\2.html\") fig.show() fig.show() ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:2:3","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Fig3 Color \u0026 Title fig = go.Figure(data=[go.Candlestick(x=df['Date'], open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'], increasing_line_color= '#5ac390', decreasing_line_color= '#fd6a6c')]) fig.update_layout( title='TWSE Stock Code:2330', yaxis_title='Price', xaxis_rangeslider_visible=False) fig.write_html(r\"C:\\Users\\User\\Downloads\\Python\\3.html\") fig.show() ####　fig.show() ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:2:4","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"每日收盤行情 import plotly.graph_objects as go import pandas as pd ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:3:0","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"SQL連線 import sqlalchemy from sqlalchemy import create_engine user = 'root' pw = \"YourPassworrd\" db = \"TWSE\" engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=db)) df = pd.read_sql(\"SELECT * FROM `每日收盤行情` WHERE `證券代號` = 2330\", engine, coerce_float=True, parse_dates=True) ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:3:1","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"rename col /可做可不做/ df = df.rename(columns = {'開盤價': 'Open','最高價':'High','收盤價':'Close','最低價':'Low','日期':'Date','成交股數':'Volume'}) ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:3:2","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Fig4 subplots from plotly.subplots import make_subplots fig = make_subplots(rows=2, cols=1) fig.add_trace(go.Candlestick(x=df['Date'], open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'], increasing_line_color= '#3D9970', decreasing_line_color= '#FF4136', increasing_fillcolor='#3D9970', decreasing_fillcolor='#FF4136')) fig.add_trace(go.Bar(y=df['Volume'],x = df['Date'],marker = dict(color=df['color'])), row=2, col=1) fig.update_layout( paper_bgcolor='#EEEEEE', plot_bgcolor='#EEEEEE', title='TWSE\u003cbr\u003eStock Code:2330', yaxis_title='Price', xaxis_rangeslider_visible=False) fig.show() fig.show() ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:3:3","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Fig5 Change subplot sizes trace1 = go.Candlestick(x=df['Date'], open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'], increasing_line_color= '#3D9970', decreasing_line_color= '#FF4136', increasing_fillcolor='#3D9970', decreasing_fillcolor='#FF4136') trace2 = go.Bar(y=df['Volume'],x = df['Date'],marker = dict(color=df['color']),yaxis='y2') data = [trace1, trace2] layout = go.Layout(yaxis2=dict(domain=[0, 0.3]), yaxis=dict(domain=[0.35,1]), xaxis_rangeslider_visible=False, title='\u003cb\u003eTWSE\u003c/b\u003e\u003cbr\u003eStock Code:2330', title_x = 0.5, title_font_size = 20, paper_bgcolor='#EEEEEE', plot_bgcolor='#EEEEEE', showlegend = False, hovermode = 'x unified', hoverlabel_bgcolor = 'rgba(255,255,255,0.9)', hoverlabel_namelength = 0) fig = go.Figure(data=data, layout=layout) fig.show() fig.show() ","date":"2020-12-05","objectID":"/twse-7-interactive-candlestick-charts/:3:4","tags":["Python","TWSE","Plotly"],"title":"TWSE [7] Interactive Candlestick Charts","uri":"/twse-7-interactive-candlestick-charts/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com MySQL to Dataframe ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:0:0","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"SQL連線 user = 'root' pw = \"YourPassworrd\" conn=MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw,charset='utf8') cursor=conn.cursor() cursor.execute(\"CREATE DATABASE IF NOT EXISTS TWSE DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_unicode_ci\" ) engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=\"TWSE\")) df = pd.read_sql(\"SELECT* FROM `twse` WHERE `Stock Code` = 2330 AND `Date` BETWEEN '2019/11/10 00:00:00' AND '2020/1/10 23:59:59'\", engine, coerce_float=True, parse_dates=True) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:1:0","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"讀取資料庫Table至Dataframe import pandas as pd df = pd.read_sql('SELECT* FROM `twse`', engine, index_col= 'Stock Code', coerce_float=True, parse_dates='Date') df ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:0","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"1 取出指定col值 print(df.['Opening Price']) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:1","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"2 取出指定index值 print(df.loc['2330']) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:2","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"3 取出指定index and col值 print(df.loc['2330']['Opening Price']) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:3","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"4 取出多個col值 df[['Opening Price', 'Closing Price']] ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:4","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"5 欄位名稱 df.columns ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:5","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"6 資料 df.values ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:6","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"7 欄位Type df.dtypes ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:7","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"8 index值 df.index ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:8","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"9 重新命名 df.rename(columns={'Opening Price': 'Open'}) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:9","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"# 實作 讀取指定index值至Dataframe df = pd.read_sql('SELECT* FROM `twse`, engine, index_col= 'Stock Code', coerce_float=True, parse_dates='Date') ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:2:10","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"mplfinance [新版] pip install mplfinance import mplfinance as mpf ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:3:0","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"每日收盤行情 SQL連線 user = 'root' pw = \"YourPassworrd\" conn=MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw,charset='utf8') cursor=conn.cursor() cursor.execute(\"CREATE DATABASE IF NOT EXISTS TWSE DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_unicode_ci\" ) engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=\"TWSE\")) df = pd.read_sql(\"SELECT* FROM `twse` WHERE `Stock Code` = 2330 AND `Date` BETWEEN '2019/11/10 00:00:00' AND '2020/1/10 23:59:59'\", engine, coerce_float=True, parse_dates=True) 重新調整Dataframe 1 刪掉多餘的Col df = df.drop(columns = ['Stock Code','Change','Transaction','Trade Value']) 2 重新命名Col df = df.rename(columns = {'Opening Price': 'Open','Highest Price':'High','Closing Price':'Close', 'Lowest Price':'Low','Closing Price':'Close','Trade Volume':'Volume'}) 3 df[‘Date’]型態改變 df['Date'] = pd.to_datetime(df['Date']) 4 重新排序 neworder = ['Open','High','Low','Close','Volume'] df = df.reindex(columns=neworder) Candlestick chart 基本 mpf.plot(df,type='candle') 美化 mc = mpf.make_marketcolors(up='#5ac390',down='#fd6a6c',volume='in',edge='None',) s = mpf.make_mpf_style(base_mpl_style='fivethirtyeight',gridstyle='None',marketcolors=mc) fig = mpf.figure(style=s,figsize=(20,20)) ax1 = fig.add_axes([0,0.3,1,0.4]) ax2 = fig.add_axes([0,0.1,1,0.2]) mav=(3,6,9) mpf.plot(df, type='candle', style=s, volume=ax2, mav=(3,6,9), panel_ratios=(4,1), xrotation=0, ax = ax1, update_width_config = dict(candle_width = 0.95), scale_width_adjustment = dict(lines=2)) ax1.legend(['mav '+str(mav[0]),'mav '+str(mav[1]),'mav '+str(mav[2])], loc='best', bbox_to_anchor=(0.2, 1.1), fontsize = 20, frameon = True, edgecolor = 'w', facecolor = 'w' ) ax1.set_title( label = '\\nTWSE\\n\\nStock Code:2330\\n', fontdict={'fontsize':30, 'fontweight':'bold', 'color':'k'}, loc='center' ) ax1.set_ylabel('Price',fontdict={'weight': 'bold', 'size': 20}) ax2.set_ylabel('Volume',fontdict={'weight': 'bold', 'size': 20}) ax1.yaxis.set_label_position(\"left\") ax1.yaxis.tick_left() yticks = np.arange(min(df['Volume']), max(df['Volume']), round( (max(df['Volume']) - min(df['Volume']))/5 )) ax2.set_yticks(yticks) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:3:1","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"免連SQL版 import pandas_datareader.data as web import mplfinance as mpf from IPython.display import Image stock_code = '0050.tw' df = web.DataReader(stock_code, 'yahoo', '2020-11-01') 基本 mpf.plot(df, type='candle', mav=(5,20), volume=True, title='\\n{stock_code}'.format(stock_code=stock_code), savefig='test_1.png') Image('test_1.png') 美化 import matplotlib.pyplot as plt import numpy as np mc = mpf.make_marketcolors(up='#5ac390',down='#fd6a6c',volume='in',edge='None',) s = mpf.make_mpf_style(base_mpl_style='fivethirtyeight',gridstyle='None',marketcolors=mc) fig = mpf.figure(style=s,figsize=(20,15)) ax1 = fig.add_axes([0.05,0.3,0.95,0.5]) ax2 = fig.add_axes([0.05,0.1,0.95,0.2]) mav = (3,6,9) mpf.plot(df, type='candle', style=s, volume=ax2, mav=mav, panel_ratios=(4,1), xrotation=0, ax = ax1, update_width_config = dict(candle_width = 0.95), scale_width_adjustment = dict(lines=2)) ax1.legend(['mav '+str(mav[0]),'mav '+str(mav[1]),'mav '+str(mav[2])], loc='best', bbox_to_anchor=(0.2, 1.1), fontsize = 20, frameon = True, edgecolor = 'w', facecolor = 'w') ax1.set_title( label = '\\n\\nStock Code:{}\\n'.format(stock_code), fontdict={'fontsize':30, 'fontweight':'bold', 'color':'k'}, loc='center') ax1.set_xticks([]) ax1.set_ylabel('Price',fontdict={'weight': 'bold', 'size': 20}) ax2.set_ylabel('Volume',fontdict={'weight': 'bold', 'size': 20}) ax1.yaxis.set_label_position(\"left\") ax1.yaxis.tick_left() yticks = np.arange(min(df['Volume']), max(df['Volume']), round( (max(df['Volume']) - min(df['Volume']))/5 )) ax2.set_yticks(yticks) plt.savefig('test_2.png', dpi=300) MACD import matplotlib.pyplot as plt import numpy as np mc = mpf.make_marketcolors(up='#5ac390',down='#fd6a6c',volume='in',edge='None',) s = mpf.make_mpf_style(base_mpl_style='fivethirtyeight',gridstyle='None',marketcolors=mc) mc = mpf.make_marketcolors(up='#5ac390',down='#fd6a6c',volume='in',edge='None',) s = mpf.make_mpf_style(base_mpl_style='fivethirtyeight',gridstyle='None',marketcolors=mc) exp12 = df['Close'].ewm(span=12, adjust=False).mean() exp26 = df['Close'].ewm(span=26, adjust=False).mean() macd = exp12 - exp26 signal = macd.ewm(span=9, adjust=False).mean() histogram = macd - signal fig = plt.figure(figsize=(20,20)) ax1 = fig.add_axes([0.05,0.4,0.94,0.5]) ax2 = fig.add_axes([0.05,0.015,0.94,0.2]) ax3 = fig.add_axes([0.05,0.2,0.94,0.2]) strDate = [str(e).split(' ')[0] for e in df['Close'].index] plt.bar(strDate, histogram, color = '#7f7f7f') plt.plot(strDate, macd, color = 'b') plt.plot(strDate, signal, color = 'r') mav = (3,6,9) mpf.plot(df, type='candle', style=s, volume=ax2, mav=mav, panel_ratios=(4,1), xrotation=0, ax = ax1, update_width_config = dict(candle_width = 0.95), scale_width_adjustment = dict(lines=2)) ax1.legend(['mav '+str(mav[0]),'mav '+str(mav[1]),'mav '+str(mav[2])], loc='best', bbox_to_anchor=(0.2, 1.1), fontsize = 20, frameon = True, edgecolor = 'w', facecolor = 'w') ax3.legend(['macd','signal'], loc='best', bbox_to_anchor=(0.2, 1.1), fontsize = 20, frameon = True, edgecolor = 'w', facecolor = 'w') ax1.set_title( label = 'MACD\\n\\nStock Code:{}\\n'.format(stock_code), fontdict={'fontsize':30, 'fontweight':'bold', 'color':'k'}, loc='center') ax1.set_ylabel('Price',fontdict={'weight': 'bold', 'size': 20}) ax2.set_ylabel('Volume',fontdict={'weight': 'bold', 'size': 20}) ax1.yaxis.set_label_position(\"left\") ax1.yaxis.tick_left() yticks = np.arange(min(df['Volume']), max(df['Volume']), round( (max(df['Volume']) - min(df['Volume']))/5 )) ax2.set_yticks(yticks) ax1.set_xticks([]) ax3.set_xticks([]) ax1.set(frame_on=False) ax2.set(frame_on=False) ax3.set(frame_on=False) plt.savefig('test_3.png', dpi=300) ","date":"2020-11-29","objectID":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/:3:2","tags":["Python","TWSE","MySQL","mplfinance","dataframe","pd.read_sql"],"title":"TWSE [6] MySQL to Dataframe \u0026 mplfinance K線圖","uri":"/twse-6-mysql-to-dataframe-mplfinance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com mpl_finance [舊版] ","date":"2020-11-29","objectID":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/:0:0","tags":["Python","TWSE","MySQL","mpl_finance"],"title":"TWSE [5] mpl_finance K線圖","uri":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"SQL連線 ","date":"2020-11-29","objectID":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/:1:0","tags":["Python","TWSE","MySQL","mpl_finance"],"title":"TWSE [5] mpl_finance K線圖","uri":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊 import MySQLdb user = 'root' pw = \"YourPassworrd\" conn=MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw,charset='utf8') cursor=conn.cursor() cursor.execute('USE STOCK') ","date":"2020-11-29","objectID":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/:1:1","tags":["Python","TWSE","MySQL","mpl_finance"],"title":"TWSE [5] mpl_finance K線圖","uri":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"mpl_finance import matplotlib.pyplot as plt import mpl_finance as mpf %matplotlib inline ","date":"2020-11-29","objectID":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/:2:0","tags":["Python","TWSE","MySQL","mpl_finance"],"title":"TWSE [5] mpl_finance K線圖","uri":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"基本設定 p = [int(e) for e in input(\"請輸入起始日期和結束日期\").split(\" \")] # 以空格隔開 period = \"`Date` BETWEEN '{}/{}/{} 00:00:00' AND '{}/{}/{} 23:59:59'\".format(p[0],p[1],p[2],p[3],p[4],p[5]) def sql_execute(column_name): SQL = \"SELECT {} FROM `twse` WHERE `Stock Code` = {} AND {} ORDER BY `Date`\" cursor.execute(SQL.format(column_name, 1234, period)) result = cursor.fetchall() return result def get_data(column_name): sql_data = [e[0] for e in sql_execute(column_name)] return sql_data ","date":"2020-11-29","objectID":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/:3:0","tags":["Python","TWSE","MySQL","mpl_finance"],"title":"TWSE [5] mpl_finance K線圖","uri":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"完整程式碼 import MySQLdb import matplotlib.pyplot as plt import mpl_finance as mpf %matplotlib inline user = 'root' pw = \"YourPassworrd\" conn=MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw,charset='utf8') cursor=conn.cursor() cursor.execute('USE STOCK') p = [int(e) for e in input(\"請輸入起始日期和結束日期\").split(\" \")] period = \"`Date` BETWEEN '{}/{}/{} 00:00:00' AND '{}/{}/{} 23:59:59'\".format(p[0],p[1],p[2],p[3],p[4],p[5]) def get_data(column_name): sql_data = [e[0] for e in sql_execute(column_name)] return sql_data def sql_execute(column_name): SQL = \"SELECT {} FROM `twse` WHERE `Stock Code` = {} AND {} ORDER BY `Date`\" cursor.execute(SQL.format(column_name, 1234, period)) result = cursor.fetchall() return result op = get_data('`Opening Price`') cp = get_data('`Closing Price`') h = get_data('`Highest Price`') l = get_data('`Lowest Price`') D = [e[0] for e in sql_execute('`Date`')] fig = plt.figure(figsize=(20, 8)) ax = fig.add_subplot(1, 1, 1) ax.set_xticks(range(0, len(D), int(round(len(D)/7,0)))) ax.set_xticklabels(D[::int(round(len(D)/7,0))]) mpf.candlestick2_ochl(ax, op, cp, h, l, width=0.6, colorup='r', colordown='g', alpha=1); Icons made by Freepik from www.flaticon.com","date":"2020-11-29","objectID":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/:4:0","tags":["Python","TWSE","MySQL","mpl_finance"],"title":"TWSE [5] mpl_finance K線圖","uri":"/twse-5-mpl_finance-k%E7%B7%9A%E5%9C%96/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com TWSE的資料存入MySQL ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:0:0","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"SQL連線 ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:1:0","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"1 基本設定 import MySQLdb user = 'root' pw = \"YourPassworrd\" ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:1:1","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"2 不使用中文 conn = MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw) cursor=conn.cursor() ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:1:2","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"3 可使用中文 / charset=‘utf8’ / conn=MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw,charset='utf8') cursor=conn.cursor() ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:1:3","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"create_engine ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:2:0","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"pymysql sqlalchemy pip install pymysql sqlalchemy from sqlalchemy import create_engine engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=\"STOCK\")) ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:2:1","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊/en/ ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:3:0","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"完整程式碼 import urllib.request, json import json import time import datetime import pandas as pd from sqlalchemy import create_engine import MySQLdb user = 'root' pw = \"YourPassworrd\" engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=\"STOCK\")) conn = MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw) cursor=conn.cursor() create_table = ''' `Stock Code` varchar(20) NOT NULL, `Date` date NOT NULL, `Trade Volume` bigint(20) NOT NULL, `Trade Value` bigint(20) NOT NULL, `Opening Price` float NOT NULL, `Highest Price` float NOT NULL, `Lowest Price` float NOT NULL, `Closing Price` float NOT NULL, `Change` float NOT NULL, `Transaction` bigint(20) NOT NULL ''' cursor.execute(\"CREATE DATABASE IF NOT EXISTS STOCK DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_unicode_ci\" ) cursor.execute('USE STOCK') cursor.execute('''CREATE TABLE IF NOT EXISTS TWSE ({})'''.format(create_table)) cursor.execute('ALTER TABLE TWSE RENAME TO TWSE_tempt') conn.commit() data ={} date_now = datetime.datetime.now() stock_list = [2330,1234] m = int(input(\"請輸入欲抓取月份數\"))-1 for j in range(0,len(stock_list)): for i in range (m,-1,-1): date = date_now - i*datetime.timedelta(days = 30.4375) url = \"http://www.twse.com.tw/en/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(str(date).split(' ')[0].replace('-',''),stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) df = pd.DataFrame(data['data'][0:len(data['data'])]) df.columns = data['fields'] df[\"Stock Code\"] = stock_list[j] df = df.set_index('Stock Code') df = df.applymap(lambda x: str(x.replace(',',''))) df.to_sql('TWSE_tempt', con = engine, if_exists = 'append', index=True) time.sleep(10) print(\"[Stock Code: #{}][{}] loading......\".format(str(stock_list[j]),data['title'].split(\" \")[0])) cursor.execute('CREATE TABLE TWSE ({})'.format(create_table)) cursor.execute('''INSERT INTO TWSE SELECT* FROM TWSE_tempt GROUP BY `Stock Code`, `Date` HAVING count(*)\u003e0''') cursor.execute('DROP TABLE TWSE_tempt') conn.commit() conn.close() print(\"All done ! ! !\") ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:3:1","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"每日收盤行情 ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:4:0","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"完整程式碼 import urllib.request, json import json import time import datetime import pandas as pd from sqlalchemy import create_engine import MySQLdb user = 'root' pw = \"YourPassworrd\" conn=MySQLdb.connect(host=\"127.0.0.1\",user=user, passwd=pw,charset='utf8') cursor=conn.cursor() cursor.execute(\"CREATE DATABASE IF NOT EXISTS TWSE DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_unicode_ci\" ) engine = create_engine(\"mysql+pymysql://{}:{}@localhost/{db}\".format(user,pw,db=\"TWSE\")) create_table = ''' `證券代號` varchar(20) NOT NULL, `證券名稱` varchar(20) NOT NULL, `成交股數` bigint(20), `成交筆數` bigint(20), `成交金額` float, `開盤價` float NOT NULL, `最高價` float NOT NULL, `最低價` float NOT NULL, `收盤價` float NOT NULL, `漲跌價差` float, `最後揭示買價` float, `最後揭示買量` float, `最後揭示賣價` float, `最後揭示賣量` bigint(20), `本益比` float, `日期` date NOT NULL ''' cursor.execute('USE TWSE') cursor.execute('''CREATE TABLE IF NOT EXISTS `每日收盤行情` ({})'''.format(create_table)) cursor.execute('ALTER TABLE `每日收盤行情` RENAME TO `每日收盤行情_tempt`') date = datetime.datetime.now() n = int(input('抓取n日資料')) for i in range(n): url = \"https://www.twse.com.tw/exchangeReport/MI_INDEX?response=jsn\u0026date={}\u0026type=ALL\".format(str(date).split(' ')[0].replace('-','')) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) if data['stat'] ==\"OK\": df = pd.DataFrame(data['data9'][0:len(data['data9'])]) df.columns = data['fields9'] df = df.drop(columns = '漲跌(+/-)') df = df.set_index('證券代號') df = df.applymap(lambda x: str(x.replace(',',''))) df[\"日期\"] = str(date).split(' ')[0].replace('-','/') df.to_sql('每日收盤行情_tempt', con = engine, if_exists = 'append', index=True) print(url) time.sleep(4) else: print(data['stat']) date = date - datetime.timedelta(days = 1) cursor.execute('CREATE TABLE `每日收盤行情` ({})'.format(create_table)) cursor.execute('''INSERT INTO `每日收盤行情` SELECT* FROM `每日收盤行情_tempt` GROUP BY `證券代號`, `日期` HAVING count(*)\u003e0''') cursor.execute('DROP TABLE `每日收盤行情_tempt`') conn.commit() conn.close() print(\"All done ! ! !\") ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:4:1","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"取出資料 ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:5:0","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊 1 回傳全部 cursor.fetchall() 2 回傳一個值 cursor.fetchone() 3 回傳多個值 cursor.fetchmany() 4 實際使用 cursor.execute(\"SELECT `Opening Price` FROM `twse` where `Stock Code` = 2330\") result = cursor.fetchall() print(result) 5 result型態 print(type(result)) tuple print(result[1][0]) 6 取出特定時間內資料 回傳 Opening Price Date BETWEEN 2019/10/10 ~ 2020/1/10 cursor.execute(\"SELECT `Opening Price` FROM `twse` WHERE `Stock Code` = 2330 AND `Date` BETWEEN '2019/10/10 00:00:00' AND '2020/1/10 23:59:59'\") result = cursor.fetchall() print(result) ","date":"2020-11-29","objectID":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/:5:1","tags":["Python","TWSE","dataframe","df.to_sql","MySQL"],"title":"TWSE [4] 資料存入MySQL及取出","uri":"/twse-4-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5mysql/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com TWSE的資料存入SQLite ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:0:0","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊 ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:1:0","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"1 SQLite連線 import sqlite3 conn = sqlite3.connect('Python_Stock_TWSE.db') c = conn.cursor() ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:1:1","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"2 建立Table c.execute('CREATE TABLE IF NOT EXISTS TWSE2330_tempt (股票代碼, 日期, 成交股數, 成交金額, 開盤價, 最高價, 最低價, 收盤價, 漲跌價差, 成交筆數)') ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:1:2","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"3 刪除Table c.execute('DROP TABLE TWSE2330_tempt') ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:1:3","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"# 完整程式碼 import pandas as pd import urllib.request, json import datetime import time import sqlite3 conn = sqlite3.connect('Python_Stock_TWSE.db') c = conn.cursor() c.execute('CREATE TABLE IF NOT EXISTS TWSE (股票代碼 int, 日期 date, 成交股數 float, 成交金額 float, 開盤價 float, 最高價 float, 最低價 float, 收盤價 float, 漲跌價差 float, 成交筆數 float)') conn.commit() date_now = datetime.datetime.now() stock_list = [2330,1234] m = int(input(\"請輸入欲抓取月份數\"))-1 for j in range(0,len(stock_list)): for i in range (m,-1,-1): date = date_now - i*datetime.timedelta(days = 30.4375) url = \"http://www.twse.com.tw/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(str(date).split(' ')[0].replace('-',''),stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) df = pd.DataFrame(data['data'][0:len(data['data'])]) df.columns = data['fields'] df[\"股票代碼\"] = stock_list[j] df = df.set_index('股票代碼') df.to_sql('TWSE', conn, if_exists='append', index = True) conn.commit() print(\"[#{}] {} is loading...\".format(stock_list[j], data['date'])) time.sleep(5) conn.close() print(\"Done\") ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:1:4","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"資料庫資料重複問題解決 ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:2:0","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"1 選出沒有重複的資料 SELECT* FROM TWSE GROUP BY 股票代碼, 日期 HAVING count(*)\u003e0 ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:2:1","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"2 TWSE_tempt當作緩存 將TWSE改成TWSE_tempt當作緩存 ，再新增一個TWSE INSERT INTO TWSE SELECT* FROM TWSE_tempt GROUP BY 股票代碼, 日期 HAVING count(*)\u003e0 c.execute('''INSERT INTO TWSE SELECT* FROM TWSE_tempt GROUP BY 股票代碼, 日期 HAVING count(*)\u003e0''') ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:2:2","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"# 完整程式碼 import pandas as pd import urllib.request, json import datetime import time import sqlite3 conn = sqlite3.connect('Python_Stock_TWSE.db') c = conn.cursor() c.execute('CREATE TABLE IF NOT EXISTS TWSE (股票代碼 int, 日期 date, 成交股數 float, 成交金額 float, 開盤價 float, 最高價 float, 最低價 float, 收盤價 float, 漲跌價差 float, 成交筆數 float)') c.execute('ALTER TABLE TWSE RENAME TO TWSE_tempt') conn.commit() date_now = datetime.datetime.now() stock_list = [2330,1234] m = int(input(\"請輸入欲抓取月份數\"))-1 for j in range(0,len(stock_list)): for i in range (m,-1,-1): date = date_now - i*datetime.timedelta(days = 30.4375) url = \"http://www.twse.com.tw/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(str(date).split(' ')[0].replace('-',''),stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) df = pd.DataFrame(data['data'][0:len(data['data'])]) df.columns = data['fields'] df[\"股票代碼\"] = stock_list[j] df = df.set_index('股票代碼') df.to_sql('TWSE_tempt', conn, if_exists='append', index = True) print(\"[{}] Month: {} is loading......\".format(str(stock_list[j]),str(date).split('-')[1])) time.sleep(5) c.execute('CREATE TABLE TWSE (股票代碼 int, 日期 date, 成交股數 float, 成交金額 float, 開盤價 float, 最高價 float, 最低價 float, 收盤價 float, 漲跌價差 float, 成交筆數 float)') c.execute('''INSERT INTO TWSE SELECT* FROM TWSE_tempt GROUP BY 股票代碼, 日期 HAVING count(*)\u003e0''') c.execute('DROP TABLE TWSE_tempt') print(\"Done\") conn.commit() conn.close() ","date":"2020-11-28","objectID":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/:2:3","tags":["Python","TWSE","dataframe","df.to_sql","SQLite"],"title":"TWSE [3] 資料存入SQLite","uri":"/twse-3-%E8%B3%87%E6%96%99%E5%AD%98%E5%85%A5sqlite/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com DataFrame存入CSV檔 ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:0:0","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊 ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:1:0","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"1 相對路徑 df.to_csv('檔案名稱.csv') ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:1:1","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"2 絕對路徑 df.to_csv (r'路徑\\檔案名稱.csv') ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:1:2","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"3 取得路徑 import os os.getcwd() ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:1:3","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"4 df.to_csv 使用 1 以\"/“隔開 df.to_csv ('檔案名稱.csv', sep='/') 2 將檔案重複寫入 df.to_csv ('檔案名稱.csv', mode = 'a') 3 替換空值 df.to_csv ('檔案名稱.csv', na_rep='NA') 4 小數4位 df.to_csv ('檔案名稱.csv', float_format='%.4f') 5 不保留列名header df.to_csv ('檔案名稱.csv', header=0) 6 不保留引索值index df.to_csv ('檔案名稱.csv', index=0) # 完整程式碼 import pandas as pd import urllib.request, json import time stock_list = [1101,1234,2330,2337] date = 20200813 for j in range(0,len(stock_list)): url = \"http://www.twse.com.tw/en/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(date,stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) stock_data.append(data) df = pd.DataFrame(data['data'][0:len(data['data'])]) df.columns = data['fields'] df[\"Stock Code\"] = stock_list[j] df = df.set_index('Stock Code') df = df.applymap(lambda x: str(x.replace(',',''))) print(\"[#{}] {} is loading...\".format(stock_list[j], data['date'])) df.to_csv (r'C:\\Users\\User\\Downloads\\Python\\Python_Stock_TWSE_type = 2330.csv', mode='a', header=0) time.sleep(5) ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:1:4","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"抓取多筆資料 ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:2:0","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"個股月成交資訊 import urllib.request, json import datetime import pandas as pd date_now = datetime.datetime.now() stock_list = [2330,1234] m = int(input(\"請輸入欲抓取月份數\"))-1 for j in range(0,len(stock_list)): for i in range (m,-1,-1): date = date_now - i*datetime.timedelta(days = 30.4375) url = \"http://www.twse.com.tw/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(str(date).split(' ')[0].replace('-',''),stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) df = pd.DataFrame(data['data'][0:len(data['data'])]) df.columns = data['fields'] df[\"股票代碼\"] = stock_list[j] df = df.set_index('股票代碼') print(df) ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:2:1","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"每日收盤行情 import urllib.request, json import datetime import time import pandas as pd date = datetime.datetime.now() n = int(input('抓取n日資料')) for i in range(n): url = \"https://www.twse.com.tw/exchangeReport/MI_INDEX?response=jsn\u0026date={}\u0026type=ALL\".format(str(date).split(' ')[0].replace('-','')) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) if data['stat'] ==\"OK\": df = pd.DataFrame(data['data9'][0:len(data['data9'])]) df.columns = data['fields9'] print(url) time.sleep(4) else: print(data['stat']) date = date - datetime.timedelta(days = 1) ","date":"2020-11-28","objectID":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/:2:2","tags":["Python","TWSE","dataframe","df.to_csv"],"title":"TWSE [2] 將DataFrame存入CSV檔 \u0026 抓取多筆資料","uri":"/twse-2-%E5%B0%87dataframe%E5%AD%98%E5%85%A5csv%E6%AA%94/"},{"categories":["Python","TWSE"],"content":"               ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"Freepik from www.flaticon.com ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:0:0","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"TWSE股票資料 ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:1:0","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"1 個股月成交資訊 個股月成交資訊以台積電2330為例 點選 列印/HTML 更改 html 為 jsn 更改 20200813為 20200713，即可找到7月資料 更改 stockNo=2330 為 stockNo=1234，即可找到黑松交易資 https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=jsn\u0026date=20200713\u0026stockNo=2330 https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=jsn\u0026date=20200713\u0026stockNo=1234 在exchangeReport前加上 /en/ 轉換成英文版 https://www.twse.com.tw/en/exchangeReport/STOCK_DAY?response=jsn\u0026date=20200713\u0026stockNo=1234 stock_list = [1234, 2330] date = 20200813 for j in range(0,len(stock_list)): url = \"http://www.twse.com.tw/en/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(date,stock_list[j]) print(url) `` ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:1:1","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"2 每日收盤行情 每日收盤行情-全部 點選 列印/HTML 更改 html 為 jsn 更改 20200827 為 20200828，即可找到8月28日資料 在exchangeReport前加上 /en/ 轉換成英文版 https://www.twse.com.tw/en/exchangeReport/MI_INDEX?response=jsn\u0026date=20200828\u0026type=ALL ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:1:2","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"解析Json檔 ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:2:0","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"1 個股月成交資訊/en/ 1 解析 import urllib.request, json stock_list = [2330] date = 20200813 for j in range(0,len(stock_list)): url = \"http://www.twse.com.tw/en/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(date,stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) print(data) 2 Json Editor for i in range(0, len(data['data'])): print(data['data'][i]) print(data['fields']) print(data['date']) print(data['title']) 3 以DataFrame呈現資料 1 DataFrame呈現 import pandas as pd df = pd.DataFrame(data['data'][0:len(data['data'])]) 2 設定欄位 df.columns = data['fields'] 3 增加Stock Code至df df[\"Stock Code\"] = stock_list[j] 4 將Stock Code 設為 index df = df.set_index('Stock Code') 5 將逗號拿掉 df = df.applymap(lambda x: str(x.replace(',',''))) # 完整程式碼 import pandas as pd import urllib.request, json stock_list = [2330] date = 20200813 for j in range(0,len(stock_list)): url = \"http://www.twse.com.tw/en/exchangeReport/STOCK_DAY?response=jsn\u0026date={}\u0026stockNo={}\".format(date,stock_list[j]) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) df = pd.DataFrame(data['data'][0:len(data['data'])]) df.columns = data['fields'] df[\"Stock Code\"] = stock_list[j] df = df.set_index('Stock Code') df = df.applymap(lambda x: str(x.replace(',',''))) df ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:2:1","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"},{"categories":["Python","TWSE"],"content":"2 每日收盤行情 解析Json檔 1 解析 import urllib.request, json import datetime date = datetime.datetime.now() url = \"https://www.twse.com.tw/exchangeReport/MI_INDEX?response=jsn\u0026date={}\u0026type=ALL\".format(str(date).split(' ')[0].replace('-','')) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) print(data) print(data['fields9']) print(data['data9']) 2 以DataFrame呈現 import pandas as pd df = pd.DataFrame(data['data9'][0:len(data['data9'])]) df.columns = data['fields9'] 3 將漲跌(+/-)刪除 df = df.drop(columns = '漲跌(+/-)') 4 將證券代號設為index df = df.set_index('證券代號') 5 將逗號拿掉 df = df.applymap(lambda x: str(x.replace(',',''))) 6 加入日期 df[\"日期\"] = str(date).split(' ')[0].replace('-','/') # 完整程式碼 import urllib.request, json import pandas as pd import datetime date = datetime.datetime.now() url = \"https://www.twse.com.tw/exchangeReport/MI_INDEX?response=jsn\u0026date={}\u0026type=ALL\".format(str(date).split(' ')[0].replace('-','')) with urllib.request.urlopen(url) as jsonfile: data = json.loads(jsonfile.read().decode()) df = pd.DataFrame(data['data9'][0:len(data['data9'])]) df.columns = data['fields9'] df = df.drop(columns = '漲跌(+/-)') df = df.set_index('證券代號') df = df.applymap(lambda x: str(x.replace(',',''))) df[\"日期\"] = str(date).split(' ')[0].replace('-','/') df ","date":"2020-11-27","objectID":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/:2:2","tags":["Python","TWSE","jsn","dataframe"],"title":"TWSE [1] jsn檔解析","uri":"/twse-1-jsn%E6%AA%94%E8%A7%A3%E6%9E%90/"}]